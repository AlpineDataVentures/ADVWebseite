---
// GTMConstent.astro
//
// Configures the Consent Manager based on Klaro.
// Documentation see here: https://klaro.org/docs/tutorials/google_tag_manager
//
// The GTM is loaded in the Base.astro - with all permissions DEACTIVATED
// Only if the user accepts the tracking via this Klaro Consent Manager the permissions are granted.
---

<!-- Klaro CSS -->
<link rel="stylesheet" href="/klaro/klaro.css" />

<!-- Banner-Container -->
<div id="klaro"></div>

<!-- Klaro JS -->
<script defer type="module" src="/klaro/klaro.js"></script>

<script type="module">
  window.klaroConfig = {
    version: 1,
    elementID: "klaro",
    cookieName: "klaro",
    privacyPolicy: "/datenschutz",
    default: false,
    acceptAll: true, // confirm on the initial dialog confirms everything
    services: [
      {
        name: "google-tag-manager",
        required: true,
        purposes: ["analytics", "marketing"],
        onInit: `
          // GTM-Grundsetup einmal pro Seite
          window.dataLayer = window.dataLayer || [];
          window.gtag = function(){window.dataLayer.push(arguments)};
          gtag('consent', 'default', {
            ad_storage: 'denied',
            analytics_storage: 'denied',
            ad_user_data: 'denied',
            ad_personalization: 'denied'
          });
          gtag('set', 'ads_data_redaction', true);
        `,
        onAccept: `
          // optional: feuere Events oder Initialisierung wenn GTM akzeptiert wird
          for (let k of Object.keys(opts.consents)) {
            if (opts.consents[k]) {
              let eventName = 'klaro-' + k + '-accepted';
              window.dataLayer.push({'event': eventName});
            }
          }
        `,
      },
      {
        name: "google-analytics",
        cookies: [/^_ga(_.*)?/],
        purposes: ["analytics", "marketing"],
        onAccept: `
          // Analytics Storage nach Zustimmung erlauben
          gtag('consent', 'update', {
            analytics_storage: 'granted'
          });
        `,
        onDecline: `
          // Analytics Storage ablehnen
          gtag('consent', 'update', {
            analytics_storage: 'denied'
          });
        `,
      },
      {
        name: "google-ads",
        cookies: [],
        purposes: ["marketing"],
        onAccept: `
          // Ads Storage + Personalisierung erlauben
          gtag('consent', 'update', {
            ad_storage: 'granted',
            ad_user_data: 'granted',
            ad_personalization: 'granted'
          });
        `,
        onDecline: `
          // Ads Storage + Personalisierung ablehnen
          gtag('consent', 'update', {
            ad_storage: 'denied',
            ad_user_data: 'denied',
            ad_personalization: 'denied'
          });
        `,
      },
    ],
  };

  // Klaro initialisieren
  if (window.klaro) {
    window.klaro.setup(window.klaroConfig);
  }
</script>
